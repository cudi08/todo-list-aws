pipeline {
        agent any
        options { skipDefaultCheckout() }
        stages {
            stage('Get Code'){
                steps {
                    sh '''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                    '''
                    //Obtener codigo del repo
                    git url: 'https://github.com/cudi08/todo-list-aws.git',
                    branch: 'develop'
                    stash name:'code', includes:'**'
                    
                }
            }
            stage('Codigo estatico'){
                agent {label 'linux1'}
                steps {
                    unstash name:'code'
                    sh '''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        flake8 --format=pylint --exit-zero src>flake8.out
                    '''
                    recordIssues sourceCodeRetention: 'LAST_BUILD', tools: [flake8(pattern: 'flake8.out')]
                }
            }
            stage('Seguridad'){
                agent {label 'linux2'}
                steps {
                    unstash name:'code'
                    sh'''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        export PYTHONPATH=$WORKSPACE
                        bandit --exit-zero -r src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
                    '''
                    recordIssues sourceCodeRetention: 'LAST_BUILD', tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')]
                }
            }
            stage('Deploy'){
                steps {
                    unstash name:'code'
                    sh'''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        sam build
                        sam validate --region us-east-1
                        sam deploy --config-env staging
                    '''
                }
            }
            stage('Rest Test'){
                agent {label 'linux2'}
                steps {
                    unstash name:'code'
                    sh'''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        export BASE_URL="https://hi9v1hzvoj.execute-api.us-east-1.amazonaws.com/Prod"
                        pytest --junitxml=result-rest.xml test/integration/todoApiTest.py
                    '''
                    junit 'result-rest.xml'
                }
            }
            stage('Promote'){
                steps {
                    withCredentials([gitUsernamePassword(credentialsId: '145fd302-6340-4b18-acf5-7cb05b83b631', gitToolName: 'git-tool')]) {
                    sh'''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        git fetch origin main
                        git checkout main
                        git config --global merge.ours.driver true
                        git reset --hard origin/main
                        git merge -X theirs develop -m "Merge autom√°tico de develop a main"
                        git push origin main
                    '''
                    }
                }
            }

        }
}